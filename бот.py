# -*- coding: utf-8 -*-
"""–±–æ—Ç –≤–∞–≤–∏–ª–æ–Ω

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1w-hpJ9DdsCoA4NL1qJIPV72SoXRJhrFe
"""

import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, InputMediaPhoto
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    CallbackContext,
    CallbackQueryHandler,
    ConversationHandler,
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
DATE, PHONE, PARENT_NAME, GIRL_NAME, AGE, EXPERIENCE, SOURCE = range(7)

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
user_data_db = {}

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
TOKEN = os.getenv('TELEGRAM_TOKEN')
ADMIN_CHAT_ID = os.getenv('ADMIN_CHAT_ID')

# –°—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ URL)
PHOTO_URLS = {
    'about1': 'https://drive.google.com/file/d/1Q6WHhZdCim3lNTT85mr8FzKUc1bEPH3D/view?usp=sharing',
    'about2': 'https://drive.google.com/file/d/1Q6WHhZdCim3lNTT85mr8FzKUc1bEPH3D/view?usp=sharing',
    'requirements1': 'https://drive.google.com/file/d/1Q6WHhZdCim3lNTT85mr8FzKUc1bEPH3D/view?usp=sharing',
    'requirements2': 'https://drive.google.com/file/d/1Q6WHhZdCim3lNTT85mr8FzKUc1bEPH3D/view?usp=sharing'
}

# ========== –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ==========

async def start(update: Update, context: CallbackContext) -> None:
    keyboard = [
        [InlineKeyboardButton("üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è", callback_data="signup")],
        [InlineKeyboardButton("‚ÑπÔ∏è –û –Ω–∞—Å", callback_data="about")],
        [InlineKeyboardButton("üéí –ß—Ç–æ –≤–∑—è—Ç—å –Ω–∞ –Ω–∞–±–æ—Ä—ã", callback_data="requirements")],
        [InlineKeyboardButton("üÜò –ü–æ–º–æ—â—å", callback_data="help")],
        [
            InlineKeyboardButton("üìÖ –ü—Ä–æ–≥—Ä–∞–º–º–∞", callback_data="program"),
            InlineKeyboardButton("üìç –ê–¥—Ä–µ—Å", callback_data="location")
        ],
        [InlineKeyboardButton("üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã", callback_data="contacts")]
    ]

    if update.message:
        await update.message.reply_text(
            "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –∑–∞–Ω—è—Ç–∏—è. ü©∞\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    else:
        query = update.callback_query
        await query.answer()
        await query.edit_message_text(
            "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –∑–∞–Ω—è—Ç–∏—è. ü©∞\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ==========

async def about(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()

    media_group = [
        InputMediaPhoto(media=PHOTO_URLS['about1']),
        InputMediaPhoto(media=PHOTO_URLS['about2'])
    ]

    await context.bot.send_media_group(
        chat_id=query.message.chat_id,
        media=media_group
    )

    await context.bot.send_message(
        chat_id=query.message.chat_id,
        text="üåü –û –Ω–∞—à–µ–π —Å—Ç—É–¥–∏–∏:\n\n"
        "–ú—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ç–∞–Ω—Ü–µ–≤–∞–ª—å–Ω–∞—è —Å—Ç—É–¥–∏—è —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã. "
        "–ù–∞—à–∏ –ø–µ–¥–∞–≥–æ–≥–∏ - –¥–∏–ø–ª–æ–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã —Å –ø–æ–±–µ–¥–∞–º–∏ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–∞—Ö."
    )

async def requirements(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()

    media_group = [
        InputMediaPhoto(media=PHOTO_URLS['requirements1']),
        InputMediaPhoto(media=PHOTO_URLS['requirements2'])
    ]

    await context.bot.send_media_group(
        chat_id=query.message.chat_id,
        media=media_group
    )

    await context.bot.send_message(
        chat_id=query.message.chat_id,
        text="üéí –ß—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π –Ω–∞ –ø–µ—Ä–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ:\n\n"
        "‚Ä¢ –£–¥–æ–±–Ω—É—é —Å–ø–æ—Ä—Ç–∏–≤–Ω—É—é –æ–¥–µ–∂–¥—É\n"
        "‚Ä¢ –ß–µ—à–∫–∏ –∏–ª–∏ –±–∞–ª–µ—Ç–∫–∏\n"
        "‚Ä¢ –ë—É—Ç—ã–ª–∫—É –≤–æ–¥—ã"
    )

async def help_command(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()

    await query.edit_message_text(
        "üÜò –ü–æ–º–æ—â—å:\n\n"
        "–ï—Å–ª–∏ –±–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:\n"
        "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π\n"
        "2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /cancel –¥–ª—è —Å–±—Ä–æ—Å–∞\n"
        "3. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º\n\n"
        "–î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è", callback_data="signup")]
        ])
    )

async def program(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()

    await query.edit_message_text(
        "üé≠ –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–Ω—è—Ç–∏–π:\n\n"
        "1. –†–∞–∑–º–∏–Ω–∫–∞ (15 –º–∏–Ω)\n"
        "2. –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å (40 –º–∏–Ω)\n"
        "3. –†–∞—Å—Ç—è–∂–∫–∞ (15 –º–∏–Ω)",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_menu")]
        ])
    )

async def location(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()

    await context.bot.send_location(
        chat_id=query.message.chat_id,
        latitude=56.468238,
        longitude=84.948214
    )

    await query.edit_message_text(
        "üìç –ê–¥—Ä–µ—Å:\n\n"
        "–≥. –¢–æ–º—Å–∫, —É–ª. –ò—Ä–∫—É—Ç—Å–∫–∏–π —Ç—Ä–∞–∫—Ç, 86/1\n"
        "–î–æ–º –∫—É–ª—å—Ç—É—Ä—ã ¬´–ú–∞—è–∫¬ª",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_menu")]
        ])
    )

async def contacts(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()

    await query.edit_message_text(
        "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã:\n\n"
        "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:\n"
        "–ü–ª–æ—Ç–Ω–∏–∫–æ–≤–∞ –ú–∞—Ä–∏–Ω–∞ –ù–∏–∫–æ–ª–∞–µ–≤–Ω–∞\n"
        "+7 (913) 880-84-58\n\n"
        "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:\n"
        "–Æ–ª–∏—è: +7 (983) 236-42-84",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_menu")]
        ])
    )

# ========== –ó–ê–ü–ò–°–¨ –ù–ê –ó–ê–ù–Ø–¢–ò–ï ==========

async def signup(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()

    keyboard = [
        [InlineKeyboardButton("üìÖ 22.05.2025 –≤ 11:00", callback_data="date_2025-05-22_11:00")],
        [InlineKeyboardButton("üìÖ 25.05.2025 –≤ 14:00", callback_data="date_2025-05-25_14:00")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel")]
    ]

    await query.edit_message_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø–∏—Å–∏:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return DATE

async def date_choice(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()
    date, time = query.data.split('_')[1], query.data.split('_')[2]
    context.user_data['date'] = f"{date} {time}"
    await query.edit_message_text(f"–í—ã–±—Ä–∞–Ω–æ: {date} {time}\n–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω:")
    return PHONE

async def phone_input(update: Update, context: CallbackContext) -> int:
    context.user_data['phone'] = update.message.text
    await update.message.reply_text("–ò–º—è —Ä–æ–¥–∏—Ç–µ–ª—è:")
    return PARENT_NAME

async def parent_name_input(update: Update, context: CallbackContext) -> int:
    context.user_data['parent_name'] = update.message.text
    await update.message.reply_text("–ò–º—è —Ä–µ–±–µ–Ω–∫–∞:")
    return GIRL_NAME

async def girl_name_input(update: Update, context: CallbackContext) -> int:
    context.user_data['girl_name'] = update.message.text
    await update.message.reply_text("–í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞:")
    return AGE

async def age_input(update: Update, context: CallbackContext) -> int:
    context.user_data['age'] = update.message.text
    await update.message.reply_text("–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ–ø—ã—Ç:")
    return EXPERIENCE

async def experience_input(update: Update, context: CallbackContext) -> int:
    context.user_data['experience'] = update.message.text
    await update.message.reply_text("–û—Ç–∫—É–¥–∞ —É–∑–Ω–∞–ª–∏ –æ –Ω–∞—Å?")
    return SOURCE

async def source_input(update: Update, context: CallbackContext) -> int:
    context.user_data['source'] = update.message.text
    user_id = update.message.from_user.id

    user_data_db[user_id] = context.user_data

    await context.bot.send_message(
        chat_id=ADMIN_CHAT_ID,
        text=f"–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å:\n{context.user_data}"
    )

    await update.message.reply_text(
        "‚úÖ –ó–∞–ø–∏—Å—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!\n"
        f"–î–∞—Ç–∞: {context.user_data['date']}\n"
        "–ñ–¥–µ–º –≤–∞—Å!"
    )
    return ConversationHandler.END

async def my_lesson(update: Update, context: CallbackContext) -> None:
    user_id = update.message.from_user.id
    if record := user_data_db.get(user_id):
        await update.message.reply_text(
            f"–í–∞—à–∞ –∑–∞–ø–∏—Å—å:\n"
            f"üìÖ {record['date']}\n"
            f"üëß {record['girl_name']}, {record['age']} –ª–µ—Ç"
        )
    else:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ –∑–∞–ø–∏—Å–∞–Ω—ã")

async def cancel_lesson(update: Update, context: CallbackContext) -> None:
    user_id = update.message.from_user.id
    if user_id in user_data_db:
        del user_data_db[user_id]
        await update.message.reply_text("‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞")
    else:
        await update.message.reply_text("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π")

async def cancel_conversation(update: Update, context: CallbackContext) -> int:
    await update.message.reply_text("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞")
    return ConversationHandler.END

async def back_to_menu(update: Update, context: CallbackContext) -> None:
    await start(update, context)

# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========

def main() -> None:
    application = Application.builder().token(TOKEN).build()

    # ConversationHandler –¥–ª—è –∑–∞–ø–∏—Å–∏
    conv_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(signup, pattern='^signup$')],
        states={
            DATE: [CallbackQueryHandler(date_choice, pattern='^date_')],
            PHONE: [MessageHandler(filters.TEXT & ~filters.COMMAND, phone_input)],
            PARENT_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, parent_name_input)],
            GIRL_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, girl_name_input)],
            AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, age_input)],
            EXPERIENCE: [MessageHandler(filters.TEXT & ~filters.COMMAND, experience_input)],
            SOURCE: [MessageHandler(filters.TEXT & ~filters.COMMAND, source_input)],
        },
        fallbacks=[CommandHandler('cancel', cancel_conversation)],
    )

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    application.add_handler(conv_handler)
    application.add_handler(CommandHandler('start', start))
    application.add_handler(CommandHandler('my_lesson', my_lesson))
    application.add_handler(CommandHandler('cancel', cancel_lesson))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    application.add_handler(CallbackQueryHandler(about, pattern='^about$'))
    application.add_handler(CallbackQueryHandler(requirements, pattern='^requirements$'))
    application.add_handler(CallbackQueryHandler(help_command, pattern='^help$'))
    application.add_handler(CallbackQueryHandler(program, pattern='^program$'))
    application.add_handler(CallbackQueryHandler(location, pattern='^location$'))
    application.add_handler(CallbackQueryHandler(contacts, pattern='^contacts$'))
    application.add_handler(CallbackQueryHandler(back_to_menu, pattern='^back_to_menu$'))

    application.run_polling()

if __name__ == '__main__':
    main()